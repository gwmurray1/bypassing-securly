var port = chrome.runtime.connect({
    name: "search_engine_parser"
});
let shContent = [];

function onWindowLoad() {
    let e = document.querySelector("title");
    e ? checkTitle(e) : setTimeout(bingIssueFix, 2e3)
}

function bingIssueFix() {
    if (-1 != document.location.hostname.indexOf("bing")) {
        let e = document.querySelector("input[type=search]");
        if (e && "" != e.value) {
            checkTitle(e.value + " - bing")
        }
    }
}

function checkTitle(e) {
    if (e && "" == e.text) return;
    searchFlaggedData(e.text)
}

function searchFlaggedData(e) {
    let t = !1;
    for (let n = 0; n < shContent.length && (-1 != e.toLowerCase().indexOf("google") ? Array.from(document.getElementsByClassName("g")).map(function (o) {
            if (indexStr = o.innerHTML.toLowerCase().indexOf(shContent[n].toLowerCase()), -1 != indexStr) {
                var a = Array.from(o.getElementsByTagName("a"))[0].href;
                t || sendSHData(e.toLowerCase().replace("- google search", "").trim(), a, shContent[n], cleanDomainName(document.domain)), t = !0
            }
        }) : -1 != e.toLowerCase().indexOf("bing") ? Array.from(document.getElementsByClassName("b_algo")).map(function (o) {
            if (indexStr = o.innerHTML.toLowerCase().indexOf(shContent[n].toLowerCase()), -1 != indexStr) {
                var a = Array.from(o.getElementsByTagName("a"))[0].href;
                t || sendSHData(e.toLowerCase().replace("- bing", "").trim(), a, shContent[n], cleanDomainName(document.domain)), t = !0
            }
        }) : -1 != e.toLowerCase().indexOf("yahoo search") && Array.from(document.getElementsByClassName("relsrch")).map(function (o) {
            if (indexStr = o.innerHTML.toLowerCase().indexOf(shContent[n].toLowerCase()), -1 != indexStr) {
                var a = Array.from(o.getElementsByTagName("a"))[0].href;
                t || sendSHData(e.toLowerCase().replace("- yahoo search results", "").trim(), a, shContent[n], cleanDomainName(document.domain)), t = !0
            }
        }), !t); n++);
    if (!t)
        for (let n = 0; n < shContent.length && (url = "", document.documentElement.innerText.indexOf(shContent[n]) > 0 && (-1 != e.toLowerCase().indexOf("google") ? (t || sendSHData(e.toLowerCase().replace("- google search", "").trim(), url, shContent[n], cleanDomainName(document.domain)), t = !0) : -1 != e.toLowerCase().indexOf("bing") ? (t || sendSHData(e.toLowerCase().replace("- bing", "").trim(), url, shContent[n], cleanDomainName(document.domain)), t = !0) : -1 != e.toLowerCase().indexOf("yahoo search") && (t || sendSHData(e.toLowerCase().replace("- yahoo search results", "").trim(), url, shContent[n], cleanDomainName(document.domain)), t = !0)), !t); n++);
}

function sendData(e) {
    port.postMessage({
        action: "fetchResult"
    })
}

function sendSHData(e, t, n, o) {
    port.postMessage({
        action: "sendSHResult",
        msg: e,
        url: t,
        matchedTerm: n,
        domain: o
    })
}

function cleanDomainName(e) {
    return e.replace(/^(?:https?:\/\/)?(?:www\.)?/i, "")
}

function callWindowLoadWithTimeOut() {
    sendData(), setTimeout(onWindowLoad, 2e3)
}
port.onMessage.addListener(function (e) {
    shContent = e
}), window.addEventListener ? window.addEventListener("load", callWindowLoadWithTimeOut, !1) : window.attachEvent && window.attachEvent("onload", callWindowLoadWithTimeOut);
